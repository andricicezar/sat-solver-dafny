# Performance experiments

We implemented the backtracking algorithm that generates all the permutation in Dafny, C#, F\* and C.
Dafny code can be extracted to C#, therefore, we compare the results of the two.
We did the same for F\* code which can be extracted in C.

## Results
Every file was compiled, and the executable was ran 20 times.
The time in the table represents the average of those 20 runs.

The tests were ran on an Intel Core i5-8250U 3.40GHz with 8GB 
of RAM, Operating System 5.1.14-arch1-1-ARCH.

| File | Language | Description | Time |
|---|---|---|---|
| dafny-perm.dfy |  Dafny | The code extracted in C# uses the native type `int` instead of `BigInteger` | 3.58s |
| csharp-perm.cs |  C# |   | 3.62s |
| fstar_perm.fst | F\* |   | 2.93s |
| fstar_perm.fst | F\* | Compiled the extracted C code with the extra flag `-O3` | 1.64s |
| fstar_perm.fst | F\* | We manually changed the dynamic allocation of memory with static allocation, and used `-O3`  | 0.79s |
| gcc-perm.c | C |   | 3.09s |
| gcc-perm.c | C | Compiled with the flag `-O3` | 0.64s |
| gcc-perm-malloc.c | C |   | 3.15s |
| gcc-perm-malloc.c | C | Compiled with the flag `-O3` | 1.74s |

## Dafny vs C#
The results show that the code generated by Dafny is as fast as the a similar version in
C#. 

## F\* vs C
The results show that the C code extracted from F\* has the same performance as a version
implemented directly in C, if the `-O3` flag is not used.
If we try to compile using the flag `-O3`, there starts to be a difference
in performance. The reason is that the F\* extracted code uses `malloc` and `calloc` to allocate 
the 2 arrays used, instead of static allocation as in `gcc-perm.c`, therefore the compiler can
do more optimization on the latter one.

## Dafny vs F\* 
F\* has a slightly better performance than Dafny. If the C code extracted from F\*
is compiled using `-O3`, the difference gets bigger in this example.


## Commands used to test

### 1. Dafny extracted to C# with int
Dafny version: 2.3.0.10506

csc version: 3.100.19.26603 (9d80dea7)

```
dafny /noVerify /compile:2 /spillTargetCode:1 dafny-perm.dfy  // extracts the code in C#
csc dafny-perm.cs /r:System.Numerics.dll
time ./dafny-perm.cs 
```

### 2. F\* extracted to C
Kremlin version: Latest commit c04d180

F\* version: F* 0.9.7.0-alpha1

```
krml fstar_perm.fst -bundle WasmSupport -no-prefix Fstar_Perm -o permfst.exe
time ./permfst.exe
```

### 3. C# implementation
csc version: 3.100.19.26603 (9d80dea7)

```
csc csharp-perm.cs
time ./csharp-perm.exe
```

### 4. C implementation
gcc version: 9.1.0

```
gcc gcc-perm.c -o out.exe
time ./out.exe
```
